name: Deploy to GCP

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # STAGE 1: Deploy Infrastructure (Firebase + Functions)
  infrastructure:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    outputs:
      firebase-api-key: ${{ steps.extract-creds.outputs.api_key }}
      firebase-auth-domain: ${{ steps.extract-creds.outputs.auth_domain }}
      firebase-database-url: ${{ steps.extract-creds.outputs.database_url }}
      firebase-project-id: ${{ steps.extract-creds.outputs.project_id }}
      firebase-storage-bucket: ${{ steps.extract-creds.outputs.storage_bucket }}
      firebase-messaging-sender-id: ${{ steps.extract-creds.outputs.messaging_sender_id }}
      firebase-app-id: ${{ steps.extract-creds.outputs.app_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/341637730794/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions@timerapp-2997d.iam.gserviceaccount.com
          token_format: 'access_token'
          access_token_lifetime: '600s'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        working-directory: ./infrastructure
        run: terraform init

      - name: Terraform Validate
        working-directory: ./infrastructure
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./infrastructure
        run: terraform plan -var-file=terraform.tfvars -out=tfplan
        # ‚úÖ Plan output will NOT show sensitive values due to 'sensitive = true'

      - name: Verify Terraform State
        working-directory: ./infrastructure
        run: |
          echo "üìã Checking Terraform state..."
          if [ -f terraform.tfstate ]; then
            echo "‚úÖ terraform.tfstate exists"
            echo "  Size: $(du -h terraform.tfstate | cut -f1)"
            echo "  Resources in state:"
            terraform state list | head -10 || echo "  (state list command failed)"
          else
            echo "‚ùå WARNING: terraform.tfstate not found!"
            echo "  This will cause resource conflicts on second deployment"
          fi

      - name: Terraform Apply (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        working-directory: ./infrastructure
        run: terraform apply -auto-approve tfplan
        # ‚úÖ Apply output will NOT show sensitive values due to 'sensitive = true'

      - name: List All Terraform Outputs
        working-directory: ./infrastructure
        run: |
          echo "üìã All Terraform outputs:"
          terraform output 2>&1 | head -50
          echo ""
          echo "Testing firebase_config specifically:"
          terraform output firebase_config 2>&1

      - name: Extract Firebase Credentials (Using Individual Outputs)
        id: extract-creds
        if: always()  # Always run this step to populate outputs (even if empty)
        working-directory: ./infrastructure
        run: |
          echo "üì• Extracting Firebase credentials from individual Terraform outputs..."
          
          # Get each output individually with error checking
          API_KEY=$(terraform output -raw firebase_api_key 2>/dev/null || echo "")
          AUTH_DOMAIN=$(terraform output -raw firebase_auth_domain 2>/dev/null || echo "")
          DATABASE_URL=$(terraform output -raw firebase_database_url 2>/dev/null || echo "")
          PROJECT_ID=$(terraform output -raw firebase_project_id 2>/dev/null || echo "")
          STORAGE_BUCKET=$(terraform output -raw firebase_storage_bucket 2>/dev/null || echo "")
          MESSAGING_SENDER_ID=$(terraform output -raw firebase_messaging_sender_id 2>/dev/null || echo "")
          APP_ID=$(terraform output -raw firebase_app_id 2>/dev/null || echo "")
          
          # Check if this is a main branch push (where values should exist)
          if [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ github.event_name }}" == "push" ]; then
            # On main branch: validate that all values were extracted
            if [ -z "$API_KEY" ] || [ -z "$AUTH_DOMAIN" ] || [ -z "$DATABASE_URL" ] || [ -z "$PROJECT_ID" ] || [ -z "$STORAGE_BUCKET" ] || [ -z "$MESSAGING_SENDER_ID" ] || [ -z "$APP_ID" ]; then
              echo "‚ùå ERROR: Some credentials are missing on main branch deployment!"
              echo "  API_KEY: ${API_KEY:+SET}${API_KEY:-MISSING}"
              echo "  AUTH_DOMAIN: ${AUTH_DOMAIN:+SET}${AUTH_DOMAIN:-MISSING}"
              echo "  DATABASE_URL: ${DATABASE_URL:+SET}${DATABASE_URL:-MISSING}"
              echo "  PROJECT_ID: ${PROJECT_ID:+SET}${PROJECT_ID:-MISSING}"
              echo "  STORAGE_BUCKET: ${STORAGE_BUCKET:+SET}${STORAGE_BUCKET:-MISSING}"
              echo "  MESSAGING_SENDER_ID: ${MESSAGING_SENDER_ID:+SET}${MESSAGING_SENDER_ID:-MISSING}"
              echo "  APP_ID: ${APP_ID:+SET}${APP_ID:-MISSING}"
              exit 1
            fi
            
            # Debug: Show what we got (masked)
            echo "Extracted values:"
            echo "  apiKey: ${API_KEY:0:10}..."
            echo "  authDomain: $AUTH_DOMAIN"
            echo "  databaseURL: $DATABASE_URL"
            echo "  projectId: $PROJECT_ID"
            echo "  storageBucket: $STORAGE_BUCKET"
            echo "  messagingSenderId: $MESSAGING_SENDER_ID"
            echo "  appId: $APP_ID"
          else
            echo "‚ÑπÔ∏è  Not a main branch push - outputs may be empty (this is expected for PRs)"
          fi
          
          # Mask sensitive values BEFORE writing to output
          # (masking after output causes the value to be corrupted)
          if [ -n "$API_KEY" ]; then
            echo "::add-mask::$API_KEY"
          fi
          
          # Write outputs - these must match the job outputs definition
          # Output names: api_key, auth_domain, database_url, project_id, storage_bucket, messaging_sender_id, app_id
          echo "api_key=$API_KEY" >> $GITHUB_OUTPUT
          echo "auth_domain=$AUTH_DOMAIN" >> $GITHUB_OUTPUT
          echo "database_url=$DATABASE_URL" >> $GITHUB_OUTPUT
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "storage_bucket=$STORAGE_BUCKET" >> $GITHUB_OUTPUT
          echo "messaging_sender_id=$MESSAGING_SENDER_ID" >> $GITHUB_OUTPUT
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          
          echo "‚úÖ All 7 credentials extracted successfully"

      - name: Debug Raw Terraform Output
        working-directory: ./infrastructure
        run: |
          echo "üîç Debugging raw Terraform output..."
          terraform output -json firebase_config || echo "‚ùå Failed to retrieve firebase_config output"
          echo "‚úÖ Debugging complete."

      - name: Verify Job Outputs Are Set
        run: |
          echo "üîç Verifying job outputs are available..."
          echo "firebase-api-key: ${{ steps.extract-creds.outputs.api_key }}"
          echo "firebase-auth-domain: ${{ steps.extract-creds.outputs.auth_domain }}"
          echo "firebase-database-url: ${{ steps.extract-creds.outputs.database_url }}"
          echo "firebase-project-id: ${{ steps.extract-creds.outputs.project_id }}"
          echo "firebase-storage-bucket: ${{ steps.extract-creds.outputs.storage_bucket }}"
          echo "firebase-messaging-sender-id: ${{ steps.extract-creds.outputs.messaging_sender_id }}"
          echo "firebase-app-id: ${{ steps.extract-creds.outputs.app_id }}"

  # STAGE 2: Build React App with Firebase Credentials
  build:
    needs: infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build React App with Firebase Credentials
        env:
          # ‚úÖ Inject credentials from infrastructure job
          # These will be masked in logs (show as ***)
          REACT_APP_FIREBASE_API_KEY: ${{ needs.infrastructure.outputs.firebase-api-key }}
          REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ needs.infrastructure.outputs.firebase-auth-domain }}
          REACT_APP_FIREBASE_DATABASE_URL: ${{ needs.infrastructure.outputs.firebase-database-url }}
          REACT_APP_FIREBASE_PROJECT_ID: ${{ needs.infrastructure.outputs.firebase-project-id }}
          REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ needs.infrastructure.outputs.firebase-storage-bucket }}
          REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ needs.infrastructure.outputs.firebase-messaging-sender-id }}
          REACT_APP_FIREBASE_APP_ID: ${{ needs.infrastructure.outputs.firebase-app-id }}
        run: |
          echo "üî® Building React app with Firebase credentials..."
          echo ""
          echo "üìã Checking environment variables:"
          [ -n "$REACT_APP_FIREBASE_API_KEY" ] && echo "  ‚úì REACT_APP_FIREBASE_API_KEY set" || echo "  ‚ùå REACT_APP_FIREBASE_API_KEY missing"
          [ -n "$REACT_APP_FIREBASE_AUTH_DOMAIN" ] && echo "  ‚úì REACT_APP_FIREBASE_AUTH_DOMAIN set" || echo "  ‚ùå REACT_APP_FIREBASE_AUTH_DOMAIN missing"
          [ -n "$REACT_APP_FIREBASE_DATABASE_URL" ] && echo "  ‚úì REACT_APP_FIREBASE_DATABASE_URL set" || echo "  ‚ùå REACT_APP_FIREBASE_DATABASE_URL missing"
          [ -n "$REACT_APP_FIREBASE_PROJECT_ID" ] && echo "  ‚úì REACT_APP_FIREBASE_PROJECT_ID set" || echo "  ‚ùå REACT_APP_FIREBASE_PROJECT_ID missing"
          [ -n "$REACT_APP_FIREBASE_STORAGE_BUCKET" ] && echo "  ‚úì REACT_APP_FIREBASE_STORAGE_BUCKET set" || echo "  ‚ùå REACT_APP_FIREBASE_STORAGE_BUCKET missing"
          [ -n "$REACT_APP_FIREBASE_MESSAGING_SENDER_ID" ] && echo "  ‚úì REACT_APP_FIREBASE_MESSAGING_SENDER_ID set" || echo "  ‚ùå REACT_APP_FIREBASE_MESSAGING_SENDER_ID missing"
          [ -n "$REACT_APP_FIREBASE_APP_ID" ] && echo "  ‚úì REACT_APP_FIREBASE_APP_ID set" || echo "  ‚ùå REACT_APP_FIREBASE_APP_ID missing"
          echo ""
          
          # Check if this is a main branch push (where credentials are required)
          if [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ github.event_name }}" == "push" ]; then
            echo "üîç Main branch deployment - validating all credentials..."
            # If any credential is missing on main branch, fail
            if [ -z "$REACT_APP_FIREBASE_API_KEY" ] || [ -z "$REACT_APP_FIREBASE_AUTH_DOMAIN" ] || \
               [ -z "$REACT_APP_FIREBASE_DATABASE_URL" ] || [ -z "$REACT_APP_FIREBASE_PROJECT_ID" ] || \
               [ -z "$REACT_APP_FIREBASE_STORAGE_BUCKET" ] || [ -z "$REACT_APP_FIREBASE_MESSAGING_SENDER_ID" ] || \
               [ -z "$REACT_APP_FIREBASE_APP_ID" ]; then
              echo "‚ùå CRITICAL: Missing Firebase credentials on main branch deployment!"
              echo "   This should not happen. Check the infrastructure job outputs."
              exit 1
            fi
            echo "‚úÖ All credentials present"
          else
            echo "‚ÑπÔ∏è  PR build - credentials may be empty (will use fallback config)"
          fi
          echo ""
          
          npm run build
          echo "‚úÖ React app built successfully"

      - name: Debug Infrastructure Outputs
        if: always()
        run: |
          echo "üîç Debugging outputs from infrastructure job..."
          echo "REACT_APP_FIREBASE_API_KEY: ${{ needs.infrastructure.outputs.firebase-api-key }}"
          echo "REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ needs.infrastructure.outputs.firebase-auth-domain }}"
          echo "REACT_APP_FIREBASE_DATABASE_URL: ${{ needs.infrastructure.outputs.firebase-database-url }}"
          echo "REACT_APP_FIREBASE_PROJECT_ID: ${{ needs.infrastructure.outputs.firebase-project-id }}"
          echo "REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ needs.infrastructure.outputs.firebase-storage-bucket }}"
          echo "REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ needs.infrastructure.outputs.firebase-messaging-sender-id }}"
          echo "REACT_APP_FIREBASE_APP_ID: ${{ needs.infrastructure.outputs.firebase-app-id }}"
          echo "‚úÖ Debugging complete."

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: build/
          retention-days: 1
          # ‚úÖ Artifacts contain built app with embedded credentials

  # STAGE 3: Deploy to Firebase Hosting
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: react-build
          path: ./build
          # ‚úÖ Build folder contains the compiled app with Firebase credentials embedded

      - name: Verify Build Artifacts
        run: |
          echo "üì¶ Build contents:"
          ls -la build/
          echo ""
          echo "üìä Build size:"
          du -sh build/

      - name: Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          
          echo "üîë Authenticating with Firebase..."
          firebase deploy \
            --project timerapp-2997d \
            --token "${{ secrets.FIREBASE_DEPLOY_TOKEN }}" \
            --only hosting \
            --message "Build #${{ github.run_number }} from GitHub Actions" \
            --debug
          
          echo ""
          echo "‚úÖ Firebase Hosting deployment complete!"
          echo "üåç Live at: https://timerapp-2997d.web.app"
          echo "‚è±Ô∏è  Deployment may take 1-2 minutes to propagate"
