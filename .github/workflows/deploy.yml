name: Deploy to GCP

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # STAGE 1: Deploy Infrastructure (Firebase + Functions)
  infrastructure:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    outputs:
      firebase-api-key: ${{ steps.extract-creds.outputs.api_key }}
      firebase-auth-domain: ${{ steps.extract-creds.outputs.auth_domain }}
      firebase-database-url: ${{ steps.extract-creds.outputs.database_url }}
      firebase-project-id: ${{ steps.extract-creds.outputs.project_id }}
      firebase-storage-bucket: ${{ steps.extract-creds.outputs.storage_bucket }}
      firebase-messaging-sender-id: ${{ steps.extract-creds.outputs.messaging_sender_id }}
      firebase-app-id: ${{ steps.extract-creds.outputs.app_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/341637730794/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions@timerapp-2997d.iam.gserviceaccount.com
          token_format: 'access_token'
          access_token_lifetime: '600s'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        working-directory: ./infrastructure
        run: terraform init

      - name: Terraform Validate
        working-directory: ./infrastructure
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./infrastructure
        run: terraform plan -var-file=terraform.tfvars -out=tfplan
        # âœ… Plan output will NOT show sensitive values due to 'sensitive = true'

      - name: Terraform Apply (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        working-directory: ./infrastructure
        run: terraform apply -auto-approve tfplan
        # âœ… Apply output will NOT show sensitive values due to 'sensitive = true'

      - name: Extract Firebase Credentials (Safely)
        id: extract-creds
        working-directory: ./infrastructure
        run: |
          # âœ… Get Firebase config JSON from Terraform
          echo "ğŸ“¥ Extracting Firebase credentials from Terraform..."
          OUTPUT=$(terraform output -json firebase_config 2>/dev/null || echo "{}")
          
          # Debug: Check if output is valid JSON
          if ! echo "$OUTPUT" | jq empty 2>/dev/null; then
            echo "âŒ Error: Firebase credentials not found in Terraform output"
            echo "This usually means: enable_firebase = false in terraform.tfvars"
            exit 1
          fi
          
          # Extract individual values using jq
          API_KEY=$(echo "$OUTPUT" | jq -r '.apiKey // empty')
          AUTH_DOMAIN=$(echo "$OUTPUT" | jq -r '.authDomain // empty')
          DATABASE_URL=$(echo "$OUTPUT" | jq -r '.databaseURL // empty')
          PROJECT_ID=$(echo "$OUTPUT" | jq -r '.projectId // empty')
          STORAGE_BUCKET=$(echo "$OUTPUT" | jq -r '.storageBucket // empty')
          MESSAGING_SENDER_ID=$(echo "$OUTPUT" | jq -r '.messagingSenderId // empty')
          APP_ID=$(echo "$OUTPUT" | jq -r '.appId // empty')
          
          # Verify all credentials were extracted
          if [ -z "$DATABASE_URL" ]; then
            echo "âŒ Error: DATABASE_URL is empty"
            echo "Terraform output was:"
            terraform output firebase_config
            exit 1
          fi
          
          # âœ… CRITICAL: Mask each credential in logs
          echo "::add-mask::$API_KEY"
          echo "::add-mask::$AUTH_DOMAIN"
          echo "::add-mask::$DATABASE_URL"
          echo "::add-mask::$PROJECT_ID"
          echo "::add-mask::$STORAGE_BUCKET"
          echo "::add-mask::$MESSAGING_SENDER_ID"
          echo "::add-mask::$APP_ID"
          
          # âœ… Set as job outputs (for next job)
          echo "api_key=$API_KEY" >> $GITHUB_OUTPUT
          echo "auth_domain=$AUTH_DOMAIN" >> $GITHUB_OUTPUT
          echo "database_url=$DATABASE_URL" >> $GITHUB_OUTPUT
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "storage_bucket=$STORAGE_BUCKET" >> $GITHUB_OUTPUT
          echo "messaging_sender_id=$MESSAGING_SENDER_ID" >> $GITHUB_OUTPUT
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          
          # âœ… IMPORTANT: Never print values themselves!
          echo "âœ… Firebase credentials extracted and masked in logs"
          echo "âœ… databaseURL: $DATABASE_URL" | sed 's/https:\/\//-https:\/\//' | sed 's/\.firebaseio\.com/ âœ“/'

  # STAGE 2: Build React App with Firebase Credentials
  build:
    needs: infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build React App with Firebase Credentials
        env:
          # âœ… Inject credentials from infrastructure job
          # These will be masked in logs (show as ***)
          REACT_APP_FIREBASE_API_KEY: ${{ needs.infrastructure.outputs.firebase-api-key }}
          REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ needs.infrastructure.outputs.firebase-auth-domain }}
          REACT_APP_FIREBASE_DATABASE_URL: ${{ needs.infrastructure.outputs.firebase-database-url }}
          REACT_APP_FIREBASE_PROJECT_ID: ${{ needs.infrastructure.outputs.firebase-project-id }}
          REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ needs.infrastructure.outputs.firebase-storage-bucket }}
          REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ needs.infrastructure.outputs.firebase-messaging-sender-id }}
          REACT_APP_FIREBASE_APP_ID: ${{ needs.infrastructure.outputs.firebase-app-id }}
        run: |
          # âœ… Credentials are available as env vars during build
          # âœ… In logs: "REACT_APP_FIREBASE_API_KEY=***" (masked)
          echo "ğŸ”¨ Building React app with Firebase credentials..."
          npm run build
          echo "âœ… React app built successfully"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: build/
          retention-days: 1
          # âœ… Artifacts contain built app with embedded credentials

  # STAGE 3: Deploy to Firebase Hosting
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: react-build
          path: ./build
          # âœ… Build folder contains the compiled app with Firebase credentials embedded

      - name: Verify Build Artifacts
        run: |
          echo "ğŸ“¦ Build contents:"
          ls -la build/
          echo ""
          echo "ğŸ“Š Build size:"
          du -sh build/

      - name: Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          
          echo "ğŸ”‘ Authenticating with Firebase..."
          firebase deploy \
            --project timerapp-2997d \
            --token "${{ secrets.FIREBASE_DEPLOY_TOKEN }}" \
            --only hosting \
            --message "Build #${{ github.run_number }} from GitHub Actions" \
            --debug
          
          echo ""
          echo "âœ… Firebase Hosting deployment complete!"
          echo "ğŸŒ Live at: https://timerapp-2997d.web.app"
          echo "â±ï¸  Deployment may take 1-2 minutes to propagate"
