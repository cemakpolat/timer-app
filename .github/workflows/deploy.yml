name: Deploy to GCP

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # STAGE 1: Deploy Infrastructure (Firebase + Functions)
  infrastructure:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    outputs:
      firebase-api-key: ${{ steps.extract-creds.outputs.api_key }}
      firebase-auth-domain: ${{ steps.extract-creds.outputs.auth_domain }}
      firebase-database-url: ${{ steps.extract-creds.outputs.database_url }}
      firebase-project-id: ${{ steps.extract-creds.outputs.project_id }}
      firebase-storage-bucket: ${{ steps.extract-creds.outputs.storage_bucket }}
      firebase-messaging-sender-id: ${{ steps.extract-creds.outputs.messaging_sender_id }}
      firebase-app-id: ${{ steps.extract-creds.outputs.app_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/341637730794/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions@timerapp-2997d.iam.gserviceaccount.com
          token_format: 'access_token'
          access_token_lifetime: '600s'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        working-directory: ./infrastructure
        run: terraform init

      - name: Terraform Validate
        working-directory: ./infrastructure
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./infrastructure
        run: terraform plan -var-file=terraform.tfvars -out=tfplan
        # ‚úÖ Plan output will NOT show sensitive values due to 'sensitive = true'

      - name: Verify Terraform State
        working-directory: ./infrastructure
        run: |
          echo "üìã Checking Terraform state..."
          if [ -f terraform.tfstate ]; then
            echo "‚úÖ terraform.tfstate exists"
            echo "  Size: $(du -h terraform.tfstate | cut -f1)"
            echo "  Resources in state:"
            terraform state list | head -10 || echo "  (state list command failed)"
          else
            echo "‚ùå WARNING: terraform.tfstate not found!"
            echo "  This will cause resource conflicts on second deployment"
          fi

      - name: Terraform Apply (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        working-directory: ./infrastructure
        run: terraform apply -auto-approve tfplan
        # ‚úÖ Apply output will NOT show sensitive values due to 'sensitive = true'

      - name: List All Terraform Outputs
        working-directory: ./infrastructure
        run: |
          echo "üìã All Terraform outputs:"
          terraform output 2>&1 | head -50
          echo ""
          echo "Testing firebase_config specifically:"
          terraform output firebase_config 2>&1

      - name: Extract Firebase Credentials (Safely)
        id: extract-creds
        working-directory: ./infrastructure
        run: |
          echo "üì• Extracting Firebase credentials from Terraform..."
          
          # Get the terraform output - use printf to be safe
          if ! OUTPUT=$(terraform output -json firebase_config 2>&1); then
            echo "‚ùå Terraform output command failed"
            echo "Available outputs:"
            terraform output
            echo "firebase_config=${empty}" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Terraform output retrieved"
          
          # Simple extraction - just pass the values through
          API_KEY=$(echo "$OUTPUT" | jq -r '.apiKey // empty')
          AUTH_DOMAIN=$(echo "$OUTPUT" | jq -r '.authDomain // empty')
          DATABASE_URL=$(echo "$OUTPUT" | jq -r '.databaseURL // empty')
          PROJECT_ID=$(echo "$OUTPUT" | jq -r '.projectId // empty')
          STORAGE_BUCKET=$(echo "$OUTPUT" | jq -r '.storageBucket // empty')
          MESSAGING_SENDER_ID=$(echo "$OUTPUT" | jq -r '.messagingSenderId // empty')
          APP_ID=$(echo "$OUTPUT" | jq -r '.appId // empty')
          
          # ‚úÖ Always set outputs to GITHUB_OUTPUT (don't exit early)
          echo "api_key=$API_KEY" >> $GITHUB_OUTPUT
          echo "auth_domain=$AUTH_DOMAIN" >> $GITHUB_OUTPUT
          echo "database_url=$DATABASE_URL" >> $GITHUB_OUTPUT
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "storage_bucket=$STORAGE_BUCKET" >> $GITHUB_OUTPUT
          echo "messaging_sender_id=$MESSAGING_SENDER_ID" >> $GITHUB_OUTPUT
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          
          # ‚úÖ Mask all values in logs
          echo "::add-mask::$API_KEY"
          echo "::add-mask::$AUTH_DOMAIN"
          echo "::add-mask::$DATABASE_URL"
          echo "::add-mask::$PROJECT_ID"
          echo "::add-mask::$STORAGE_BUCKET"
          echo "::add-mask::$MESSAGING_SENDER_ID"
          echo "::add-mask::$APP_ID"
          
          echo ""
          echo "‚úÖ Credentials set as outputs"
          echo "::add-mask::$PROJECT_ID"
          echo "::add-mask::$STORAGE_BUCKET"
          echo "::add-mask::$MESSAGING_SENDER_ID"
          echo "::add-mask::$APP_ID"
          
          echo ""
          echo "‚úÖ Firebase credentials extracted successfully"

  # STAGE 2: Build React App with Firebase Credentials
  build:
    needs: infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build React App with Firebase Credentials
        env:
          # ‚úÖ Inject credentials from infrastructure job
          # These will be masked in logs (show as ***)
          REACT_APP_FIREBASE_API_KEY: ${{ needs.infrastructure.outputs.firebase-api-key }}
          REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ needs.infrastructure.outputs.firebase-auth-domain }}
          REACT_APP_FIREBASE_DATABASE_URL: ${{ needs.infrastructure.outputs.firebase-database-url }}
          REACT_APP_FIREBASE_PROJECT_ID: ${{ needs.infrastructure.outputs.firebase-project-id }}
          REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ needs.infrastructure.outputs.firebase-storage-bucket }}
          REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ needs.infrastructure.outputs.firebase-messaging-sender-id }}
          REACT_APP_FIREBASE_APP_ID: ${{ needs.infrastructure.outputs.firebase-app-id }}
        run: |
          echo "üî® Building React app with Firebase credentials..."
          echo ""
          echo "‚úÖ Environment variables received:"
          [ -n "$REACT_APP_FIREBASE_API_KEY" ] && echo "  ‚úì REACT_APP_FIREBASE_API_KEY set" || echo "  ‚ùå REACT_APP_FIREBASE_API_KEY missing"
          [ -n "$REACT_APP_FIREBASE_AUTH_DOMAIN" ] && echo "  ‚úì REACT_APP_FIREBASE_AUTH_DOMAIN set" || echo "  ‚ùå REACT_APP_FIREBASE_AUTH_DOMAIN missing"
          [ -n "$REACT_APP_FIREBASE_DATABASE_URL" ] && echo "  ‚úì REACT_APP_FIREBASE_DATABASE_URL set" || echo "  ‚ùå REACT_APP_FIREBASE_DATABASE_URL missing"
          [ -n "$REACT_APP_FIREBASE_PROJECT_ID" ] && echo "  ‚úì REACT_APP_FIREBASE_PROJECT_ID set" || echo "  ‚ùå REACT_APP_FIREBASE_PROJECT_ID missing"
          [ -n "$REACT_APP_FIREBASE_STORAGE_BUCKET" ] && echo "  ‚úì REACT_APP_FIREBASE_STORAGE_BUCKET set" || echo "  ‚ùå REACT_APP_FIREBASE_STORAGE_BUCKET missing"
          [ -n "$REACT_APP_FIREBASE_MESSAGING_SENDER_ID" ] && echo "  ‚úì REACT_APP_FIREBASE_MESSAGING_SENDER_ID set" || echo "  ‚ùå REACT_APP_FIREBASE_MESSAGING_SENDER_ID missing"
          [ -n "$REACT_APP_FIREBASE_APP_ID" ] && echo "  ‚úì REACT_APP_FIREBASE_APP_ID set" || echo "  ‚ùå REACT_APP_FIREBASE_APP_ID missing"
          echo ""
          
          # If DATABASE_URL is missing, warn and fail
          if [ -z "$REACT_APP_FIREBASE_DATABASE_URL" ]; then
            echo "‚ùå CRITICAL: REACT_APP_FIREBASE_DATABASE_URL not received from infrastructure job!"
            exit 1
          fi
          
          npm run build
          echo "‚úÖ React app built successfully"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: build/
          retention-days: 1
          # ‚úÖ Artifacts contain built app with embedded credentials

  # STAGE 3: Deploy to Firebase Hosting
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: react-build
          path: ./build
          # ‚úÖ Build folder contains the compiled app with Firebase credentials embedded

      - name: Verify Build Artifacts
        run: |
          echo "üì¶ Build contents:"
          ls -la build/
          echo ""
          echo "üìä Build size:"
          du -sh build/

      - name: Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          
          echo "üîë Authenticating with Firebase..."
          firebase deploy \
            --project timerapp-2997d \
            --token "${{ secrets.FIREBASE_DEPLOY_TOKEN }}" \
            --only hosting \
            --message "Build #${{ github.run_number }} from GitHub Actions" \
            --debug
          
          echo ""
          echo "‚úÖ Firebase Hosting deployment complete!"
          echo "üåç Live at: https://timerapp-2997d.web.app"
          echo "‚è±Ô∏è  Deployment may take 1-2 minutes to propagate"
