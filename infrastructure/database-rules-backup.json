{
  "rules": {
    "presence": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$userId": {
        ".validate": "newData.child('userId').val() === auth.uid",
        "lastSeen": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },
        "status": {
          ".validate": "newData.val() === 'online' || newData.val() === 'away'"
        }
      }
    },
    "focusRooms": {
      ".read": true,
      ".indexOn": ["createdAt", "createdBy", "name"],
      "$roomId": {
        ".write": "newData.child('createdBy').val() === auth.uid || root.child('admins').child(auth.uid).exists()",
        ".validate": "newData.hasChildren(['name', 'createdBy', 'createdAt', 'settings'])",
        "name": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
        },
        "description": {
          ".validate": "newData.isString() && newData.val().length <= 500"
        },
        "createdAt": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },
        "createdBy": {
          ".validate": "newData.isString() && newData.val() === auth.uid"
        },
        "settings": {
          ".validate": "newData.isObject()",
          "isPrivate": {
            ".validate": "newData.isBoolean()"
          },
          "focusSessionDuration": {
            ".validate": "newData.isNumber() && newData.val() > 0"
          },
          "breakDuration": {
            ".validate": "newData.isNumber() && newData.val() > 0"
          }
        },
        "participants": {
          ".read": true,
          ".write": "parent.parent.child('createdBy').val() === auth.uid || $userId === auth.uid",
          "$userId": {
            ".write": "$userId === auth.uid || parent.parent.parent.child('createdBy').val() === auth.uid",
            ".read": true,
            "joinedAt": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            },
            "displayName": {
              ".validate": "newData.isString() && newData.val().length > 0"
            },
            "status": {
              ".validate": "newData.val() === 'active' || newData.val() === 'away' || newData.val() === 'idle'"
            }
          }
        },
        "sessions": {
          ".read": true,
          ".write": "parent.parent.child('createdBy').val() === auth.uid",
          ".indexOn": ["startTime", "endTime"],
          "$sessionId": {
            "startTime": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            },
            "endTime": {
              ".validate": "newData.isNumber() && newData.val() >= root.child('focusRooms').child(parent.parent.parent.key).child('sessions').child($sessionId).child('startTime').val()"
            },
            "focusedUsers": {
              "$userId": {
                ".validate": "newData.isBoolean()"
              }
            }
          }
        }
      }
    },
    "users": {
      "$userId": {
        ".read": "$userId === auth.uid || root.child('admins').child(auth.uid).exists()",
        ".write": "$userId === auth.uid",
        ".validate": "newData.hasChildren(['email', 'displayName', 'createdAt'])",
        "email": {
          ".validate": "newData.isString() && newData.val().matches(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/)"
        },
        "displayName": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
        },
        "photoURL": {
          ".validate": "!newData.exists() || (newData.isString() && newData.val().length <= 500)"
        },
        "createdAt": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },
        "preferences": {
          ".write": "$userId === auth.uid",
          ".read": "$userId === auth.uid",
          "theme": {
            ".validate": "newData.val() === 'light' || newData.val() === 'dark' || newData.val() === 'auto'"
          },
          "notificationsEnabled": {
            ".validate": "newData.isBoolean()"
          },
          "soundEnabled": {
            ".validate": "newData.isBoolean()"
          }
        },
        "stats": {
          ".write": "$userId === auth.uid || root.child('admins').child(auth.uid).exists()",
          ".read": "$userId === auth.uid || root.child('admins').child(auth.uid).exists()",
          "totalFocusSessions": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "totalFocusTime": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "longestStreak": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "achievements": {
            "$achievementId": {
              ".validate": "newData.isBoolean()"
            }
          }
        }
      }
    },
    "timers": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$timerId": {
        ".validate": "newData.child('userId').val() === auth.uid",
        "userId": {
          ".validate": "newData.val() === auth.uid"
        },
        "type": {
          ".validate": "newData.val() === 'timer' || newData.val() === 'stopwatch' || newData.val() === 'interval'"
        },
        "duration": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },
        "createdAt": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        }
      }
    },
    "sharedTimers": {
      ".read": true,
      ".write": "auth != null",
      "$shareId": {
        ".validate": "newData.hasChildren(['timerId', 'createdBy', 'createdAt'])",
        "timerId": {
          ".validate": "newData.isString() && newData.val().length > 0"
        },
        "createdBy": {
          ".validate": "newData.val() === auth.uid"
        },
        "createdAt": {
          ".validate": "newData.isNumber() && newData.val() > 0"
        },
        "expiresAt": {
          ".validate": "newData.isNumber() && newData.val() > root.child('sharedTimers').child($shareId).child('createdAt').val()"
        }
      }
    },
    "notifications": {
      "$userId": {
        ".read": "$userId === auth.uid",
        ".write": "$userId === auth.uid || root.child('admins').child(auth.uid).exists()",
        "$notificationId": {
          ".validate": "newData.hasChildren(['type', 'createdAt'])",
          "type": {
            ".validate": "newData.isString() && (newData.val() === 'sessionEnded' || newData.val() === 'roomInvite' || newData.val() === 'achievement')"
          },
          "createdAt": {
            ".validate": "newData.isNumber() && newData.val() > 0"
          },
          "read": {
            ".validate": "newData.isBoolean()"
          }
        }
      }
    },
    "admins": {
      ".read": "root.child('admins').child(auth.uid).exists()",
      ".write": "root.child('admins').child(auth.uid).exists()",
      "$uid": {
        ".validate": "newData.isBoolean()"
      }
    },
    ".read": false,
    ".write": false
  }
}
